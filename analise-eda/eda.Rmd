---
title: "R Notebook"
output: html_notebook
---

```{r warning=FALSE}
library(tidyverse)
library(stringr)
```

# EDA dos dados de estimativa de insatisfação

## Subtítulo

Dados coletados na sala. 

```{r}
avaliacoes = read_csv("../data/experimento-avaliacao-humana/experimento-de-avaliacao.csv", 
                      col_types = "ccd")

avaliacoes = avaliacoes %>% 
    select(avaliador = `Sua matrícula`, 
           id_reclamacao = `Id da reclamação`, 
           insatisfacao = Insatisfação)

glimpse(avaliacoes)
```

## Limpeza

Excluimos as avaliações 1 a 5 pois estas foram utilizadas para a calibragem de nota

```{r}
avaliacoes = avaliacoes %>% 
    filter(! (id_reclamacao %in% 1:5 ))
```


## Outro subtítulo

Aqui temos alguns dados gerais como a média e mediana de respostas por reclamação, assim como a quantidade de respostas por reclamação. Esse dado é utilizado para saber se a amostra que pegamos é representativa o suficiente para podermos afirmar que há um consenso em relação à insatisfação de uma reclamação

```{r}
avaliacoes %>% 
    group_by(id_reclamacao) %>% 
    count() %>% 
    ggplot(aes("reclamacoes", n)) + 
    geom_jitter(width = .05, alpha = .7)

avaliacoes %>% 
    group_by(id_reclamacao) %>% 
    count() %>%
    ungroup() %>% 
    summarise(media = mean(n), 
              mediana = median(n))

```

A partir de tais dados, é possível dizer que houve um consenso no sentido de que existe um consenso se a diferença entre o terceiro quartil e primeiro quartil seja < 1. Para analisar os léxicos iremos normalizar o resultado dado pelos mesmos para que eles se adequem à nossa escala. Em seguida, consideraremos um acerto se o resultado normalizado estiver dentro do primeiro e terceiro quartil.

```{r}
avaliacoes %>% 
    ggplot(aes(x = reorder(id_reclamacao, insatisfacao, fun = median), y = insatisfacao)) + 
    geom_boxplot() #+     geom_jitter(width = .1, alpha = .7)

```


```{r}
avaliacoes %>% 
    group_by(id_reclamacao) %>% 
    ggplot(aes(reorder(id_reclamacao, insatisfacao,FUN = median), insatisfacao, colour = id_reclamacao)) + 
    geom_jitter()
```

### contar numero de revisoes por reclamacao

```{r}
avaliacoes %>% group_by(id_reclamacao) %>% 
          summarize(count=n()) %>% 
          ggplot(aes(x=reorder(id_reclamacao, count), y=count)) + geom_bar(stat = "identity")

```

### contar numero de revisoes por aluno

O dado de quantas revisões cada aluno fez pode ser útil para estimar o esforço e a velocidade de revisão de uma reclamação.

```{r}
avaliacoes %>% group_by(avaliador) %>% 
  summarize(count=n()) %>% 
  ggplot(aes(x=reorder(avaliador, count), y=count)) + geom_bar(stat = "identity") + theme(axis.text.x=element_text(color = "black", angle=90, vjust=.8, hjust=0.8))
```

## Análise das reclamações completas

### Pegando dados
```{r}
rec_completo = read_csv("../data/reclamacoes-raw/reclamacoes-raw.csv", 
                      col_types = "cccc")

glimpse(rec_completo)
```

### salvando comprimento da reclamacao e nome do órgão

```{r}
# Comprimento da reclamação e colocando na coluna "comprimento_reclamacao"
# salvando nome legivel do orgao da reclamação na coluna "nome_orgao"
rec_completo <- rec_completo %>%  
    mutate(comprimento_reclamacao = str_length(reclamacao), 
           nome_orgao = str_split(link, "/") %>% map_chr(~ .[[5]]))

# remove coluna orgao já que não é mais necessária
rec_completo <- subset(rec_completo, select = -c(orgao))
```

### Boxplot: orgao vs tamanho da reclamacao

Neste boxplot podemos ter uma noção da quantidade de caracteres que as reclamações tem. Decidimos dividir por orgão para sabermos se existe alguma relação entre o mesmo e o tamanho das reclamaçõs. Pelo gráfico, nós acreditamos que sim.

```{r, fig.width = 12, fig.height = 10}
rec_completo %>% group_by(nome_orgao) %>% 
  ggplot(aes(x=reorder(nome_orgao, comprimento_reclamacao), y=comprimento_reclamacao)) + geom_boxplot() +  theme(axis.text.x=element_text(color = "black", angle=90, vjust=.8, hjust=0.8))
```


### Número de reclamações por órgão

```{r, fig.width = 12, fig.height = 6}
rec_completo %>% group_by(nome_orgao) %>%
  summarize(count = n()) %>%
  ggplot(aes(x=reorder(nome_orgao, count), y=count)) + geom_boxplot()             + theme(axis.text.x=element_text(color = "black", angle=90, vjust=.8, hjust=0.8))
```


### Avaliacao da metrica capslock

O dataframe existente foi expandido com a criacao de uma nova coluna chamada numero_de_capslock, a qual mapeia o numero de palavras em capslock das reclamacoes da coluna reclamacao do mesmo dataframe. O calculo dessa serie de valores incluiu o emprego de uma expressao regular.  

```{r}
rec_completo$numero_de_capslock <- str_count(rec_completo$reclamacao, "\\b[A-Z\u00C0-\u00DC]{2,}\\b")
glimpse(rec_completo)
```

O dataframe existente foi expandido com a criacao de uma nova coluna chamada texto_capslock, a qual mapeia a lista de palavras em capslock das reclamacoes da coluna reclamacao do mesmo dataframe. O calculo dessa serie de valores incluiu o emprego de uma expressao regular.

```{r}
rec_completo$texto_capslock <- str_extract_all(rec_completo$reclamacao, "\\b[A-Z\u00C0-\u00DC]{2,}\\b")
glimpse(rec_completo)
```


### Boxplot: Orgao vs quantidade de capslock

Também decidimos avaliar a quantidade de palavras em capslock nas reclamações, já que talvez este possa também ser utilizado para medir insatisfação. Dividimos por orgão para sabermos se existe uma diferença consideravel neste quesito, e pelo gráfico podemos ver que realmente alguns orgãos recebem muito mais reclamações com capslock do que outras.
Vale a pena observar também que siglas foram inclusas como palavras com capslock, o que pode enviezar tal quesito

```{r, fig.width = 12, fig.height = 12}
rec_completo %>% group_by(nome_orgao) %>% 
  ggplot(aes(x=reorder(nome_orgao, numero_de_capslock), y=numero_de_capslock)) + geom_boxplot() + theme(axis.text.x=element_text(color = "black", angle=90, vjust=.8, hjust=0.8))
```